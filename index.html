<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Simple D&D Combat Grid</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Cinzel', serif;
      background: #f4e4bc url("https://www.transparenttextures.com/patterns/aged-paper.png") repeat;
      color: #4a2c0f;
    }
    
    .app-container {
      background-color: #1a222e;
      color: #f4e4bc;
    }
    
    .combat-grid {
      display: grid;
      grid-template-columns: repeat(18, 30px);
      grid-template-rows: repeat(18, 30px);
      gap: 1px;
      background-color: #6e5c45;
      padding: 1px;
      border: 2px solid #8B4513;
      margin: 0 auto;
      max-width: 100%;
      overflow: auto;
    }
    
    .grid-cell {
      background-color: #f9efd4;
      position: relative;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .grid-cell:hover {
      background-color: #f0e6c3;
    }
    
    .coordinate {
      position: absolute;
      top: 1px;
      left: 1px;
      font-size: 8px;
      color: #8B4513;
    }
    
    .token {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      font-size: 10px;
      cursor: move;
    }
    
    .token-party {
      background-color: #3366cc;
      border: 1px solid #0033cc;
    }
    
    .token-enemy {
      background-color: #cc3333;
      border: 1px solid #991a1a;
    }
    
    .token-neutral {
      background-color: #ffcc00;
      border: 1px solid #cc9900;
      color: black;
    }
    
    .difficult-terrain {
      background-color: #e6cd9d;
      background-image: url('https://www.transparenttextures.com/patterns/diamond-upholstery.png');
    }
    
    .btn-primary {
      background-color: #8B0000;
      color: #f4e4bc;
      border: 1px solid #4a3f35;
    }
    
    .btn-primary:hover {
      background-color: #6d0101;
    }
    
    input, select, button {
      font-family: 'Cinzel', serif;
    }
    
    input, select {
      color: black;
      background-color: #f9efd4;
    }
    
    table {
      border-collapse: collapse;
      width: 100%;
    }
    
    table th {
      background-color: #2c1a0f;
      color: #f4e4bc;
      padding: 8px;
      text-align: left;
    }
    
    table td {
      padding: 8px;
      border: 1px solid #4a3f35;
      background-color: #1e2a38;
      color: #f4e4bc;
    }
    
    h2, h3 {
      color: #f4e4bc;
      border-bottom: 2px solid #8B0000;
      margin-bottom: 10px;
      padding-bottom: 5px;
    }
    
    /* Mobile responsive */
    @media (max-width: 640px) {
      .combat-grid {
        grid-template-columns: repeat(18, 25px);
        grid-template-rows: repeat(18, 25px);
      }
      
      .token {
        width: 20px;
        height: 20px;
        font-size: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="app-container p-4 max-w-6xl mx-auto my-8 rounded shadow-lg">
    <h1 class="text-2xl font-bold mb-4 text-center">D&D Combat Tracker</h1>
    
    <!-- Controls -->
    <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="bg-gray-800 p-4 rounded-lg">
        <h3 class="text-lg mb-2">Add Token</h3>
        <div class="flex flex-wrap gap-2 mb-2">
          <input type="text" id="tokenName" placeholder="Token Name" class="border p-1 rounded">
          <input type="number" id="tokenHP" placeholder="HP (optional)" class="border p-1 rounded w-24">
          <select id="tokenType" class="border p-1 rounded">
            <option value="party">Party</option>
            <option value="enemy">Enemy</option>
            <option value="neutral">Neutral</option>
          </select>
        </div>
        <p class="text-sm text-amber-300 mb-2">Enter a name and click on the grid to place a token</p>
        <div class="flex gap-2">
          <button id="terrainModeBtn" class="px-3 py-1 bg-amber-900 text-white rounded">Terrain Mode: OFF</button>
          <button id="clearGridBtn" class="px-3 py-1 bg-red-800 text-white rounded">Clear Grid</button>
        </div>
      </div>
      
      <div class="bg-gray-800 p-4 rounded-lg">
        <h3 class="text-lg mb-2">Initiative Controls</h3>
        <div class="flex flex-wrap gap-2">
          <input type="text" id="initiativeName" placeholder="Combatant Name" class="border p-1 rounded">
          <select id="initiativeType" class="border p-1 rounded">
            <option value="party">Party</option>
            <option value="enemy">Enemy</option>
            <option value="neutral">Neutral</option>
          </select>
          <input type="number" id="dexMod" placeholder="DEX Mod" class="border p-1 rounded w-20" value="0">
          <button id="addToCombatBtn" class="px-3 py-1 btn-primary rounded">Add</button>
        </div>
        <div class="flex flex-wrap gap-2 mt-2">
          <button id="rollInitiativeBtn" class="px-3 py-1 btn-primary rounded">Roll Initiative</button>
          <button id="surpriseRollBtn" class="px-3 py-1 btn-primary rounded">Surprise Roll</button>
          <button id="nextTurnBtn" class="px-3 py-1 btn-primary rounded">Next Turn</button>
          <button id="resetCombatBtn" class="px-3 py-1 bg-red-800 text-white rounded">Reset</button>
        </div>
        <div class="mt-2 bg-gray-700 p-2 rounded">
          <span id="roundDisplay" class="text-amber-300 font-bold">Round: 1</span>
          <span id="turnDisplay" class="ml-4 text-amber-300 font-bold">Current: None</span>
        </div>
      </div>
    </div>
    
    <!-- Combat Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <div class="lg:col-span-2 overflow-auto">
        <h2 class="text-xl mb-2">Combat Grid</h2>
        <div id="combatGrid" class="combat-grid"></div>
      </div>
      
      <div>
        <h2 class="text-xl mb-2">Initiative Tracker</h2>
        <table id="initiativeTable">
          <thead>
            <tr>
              <th>Init</th>
              <th>Name</th>
              <th>Type</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="initiativeBody">
            <!-- Initiative rows will be added here -->
            <tr>
              <td colspan="4" class="text-center">Add combatants to start tracking initiative</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Token Management -->
    <div class="mt-6">
      <h2 class="text-xl mb-2">Token Management</h2>
      <table id="tokenTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Type</th>
            <th>HP</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tokenBody">
          <!-- Token rows will be added here -->
          <tr>
            <td colspan="4" class="text-center">No tokens on the grid yet</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // State
      const state = {
        tokens: [],
        combatants: [],
        terrainMode: false,
        currentTurn: 0,
        round: 1,
        selectedToken: null
      };
      
      // DOM Elements
      const combatGrid = document.getElementById('combatGrid');
      const tokenNameInput = document.getElementById('tokenName');
      const tokenHPInput = document.getElementById('tokenHP');
      const tokenTypeSelect = document.getElementById('tokenType');
      const terrainModeBtn = document.getElementById('terrainModeBtn');
      const clearGridBtn = document.getElementById('clearGridBtn');
      
      const initiativeNameInput = document.getElementById('initiativeName');
      const initiativeTypeSelect = document.getElementById('initiativeType');
      const dexModInput = document.getElementById('dexMod');
      const addToCombatBtn = document.getElementById('addToCombatBtn');
      const rollInitiativeBtn = document.getElementById('rollInitiativeBtn');
      const surpriseRollBtn = document.getElementById('surpriseRollBtn');
      const nextTurnBtn = document.getElementById('nextTurnBtn');
      const resetCombatBtn = document.getElementById('resetCombatBtn');
      
      const roundDisplay = document.getElementById('roundDisplay');
      const turnDisplay = document.getElementById('turnDisplay');
      const initiativeBody = document.getElementById('initiativeBody');
      const tokenBody = document.getElementById('tokenBody');
      
      // Create grid
      function createGrid() {
        combatGrid.innerHTML = '';
        for (let row = 0; row < 18; row++) {
          for (let col = 0; col < 18; col++) {
            const cell = document.createElement('div');
            cell.className = 'grid-cell';
            cell.dataset.row = row;
            cell.dataset.col = col;
            
            // Add coordinate label
            const coord = document.createElement('span');
            coord.className = 'coordinate';
            coord.textContent = `${String.fromCharCode(65 + col)}${row + 1}`;
            cell.appendChild(coord);
            
            cell.addEventListener('click', () => handleCellClick(row, col));
            combatGrid.appendChild(cell);
          }
        }
        renderTokens();
      }
      
      // Handle cell click
      function handleCellClick(row, col) {
        if (state.selectedToken) {
          // Move selected token
          const token = state.tokens.find(t => t.id === state.selectedToken);
          if (token) {
            token.row = row;
            token.col = col;
            state.selectedToken = null;
            renderTokens();
            updateTokenTable();
          }
        } else if (state.terrainMode) {
          // Toggle terrain
          const terrainIndex = state.tokens.findIndex(t => 
            t.isTerrain && t.row === row && t.col === col
          );
          
          if (terrainIndex >= 0) {
            state.tokens.splice(terrainIndex, 1);
          } else {
            state.tokens.push({
              id: Date.now() + Math.random(),
              name: 'difficult',
              type: 'terrain',
              isTerrain: true,
              row,
              col
            });
          }
          renderTokens();
        } else if (tokenNameInput.value.trim()) {
          // Add new token
          state.tokens.push({
            id: Date.now() + Math.random(),
            name: tokenNameInput.value.trim(),
            type: tokenTypeSelect.value,
            hp: tokenHPInput.value ? parseInt(tokenHPInput.value) : null,
            maxHp: tokenHPInput.value ? parseInt(tokenHPInput.value) : null,
            row,
            col
          });
          tokenNameInput.value = '';
          tokenHPInput.value = '';
          renderTokens();
          updateTokenTable();
        }
      }
      
      // Render tokens on grid
      function renderTokens() {
        // Clear existing tokens
        document.querySelectorAll('.token').forEach(el => el.remove());
        document.querySelectorAll('.grid-cell.difficult-terrain').forEach(el => {
          el.classList.remove('difficult-terrain');
        });
        
        // Add terrain
        state.tokens.filter(t => t.isTerrain).forEach(terrain => {
          const cell = document.querySelector(`.grid-cell[data-row="${terrain.row}"][data-col="${terrain.col}"]`);
          if (cell) {
            cell.classList.add('difficult-terrain');
          }
        });
        
        // Add tokens
        state.tokens.filter(t => !t.isTerrain).forEach(token => {
          const cell = document.querySelector(`.grid-cell[data-row="${token.row}"][data-col="${token.col}"]`);
          if (cell) {
            const tokenEl = document.createElement('div');
            tokenEl.className = `token token-${token.type}`;
            tokenEl.textContent = token.name.substring(0, 2).toUpperCase();
            tokenEl.dataset.id = token.id;
            
            tokenEl.addEventListener('click', (e) => {
              e.stopPropagation();
              selectToken(token.id);
            });
            
            cell.appendChild(tokenEl);
          }
        });
      }
      
      // Select token for moving
      function selectToken(id) {
        state.selectedToken = id;
        document.querySelectorAll('.token').forEach(el => {
          el.style.boxShadow = el.dataset.id === id ? '0 0 0 2px yellow' : '';
        });
      }
      
      // Update token table
      function updateTokenTable() {
        const tokens = state.tokens.filter(t => !t.isTerrain);
        if (tokens.length === 0) {
          tokenBody.innerHTML = '<tr><td colspan="4" class="text-center">No tokens on the grid yet</td></tr>';
          return;
        }
        
        tokenBody.innerHTML = '';
        tokens.forEach(token => {
          const row = document.createElement('tr');
          
          const nameCell = document.createElement('td');
          nameCell.textContent = token.name;
          row.appendChild(nameCell);
          
          const typeCell = document.createElement('td');
          typeCell.innerHTML = `<span class="inline-block w-3 h-3 rounded-full bg-${token.type === 'party' ? 'blue' : token.type === 'enemy' ? 'red' : 'yellow'}-500 mr-1"></span> ${token.type}`;
          row.appendChild(typeCell);
          
          const hpCell = document.createElement('td');
          if (token.hp !== null) {
            const hpInput = document.createElement('input');
            hpInput.type = 'number';
            hpInput.value = token.hp;
            hpInput.className = 'border p-0.5 w-16 text-center';
            hpInput.addEventListener('change', (e) => {
              token.hp = parseInt(e.target.value) || 0;
            });
            hpCell.appendChild(hpInput);
          } else {
            hpCell.textContent = 'N/A';
          }
          row.appendChild(hpCell);
          
          const actionsCell = document.createElement('td');
          
          const moveBtn = document.createElement('button');
          moveBtn.textContent = 'Move';
          moveBtn.className = 'px-2 py-0.5 btn-primary rounded text-xs mr-1';
          moveBtn.addEventListener('click', () => selectToken(token.id));
          actionsCell.appendChild(moveBtn);
          
          const removeBtn = document.createElement('button');
          removeBtn.textContent = 'Remove';
          removeBtn.className = 'px-2 py-0.5 bg-red-800 text-white rounded text-xs';
          removeBtn.addEventListener('click', () => {
            state.tokens = state.tokens.filter(t => t.id !== token.id);
            renderTokens();
            updateTokenTable();
          });
          actionsCell.appendChild(removeBtn);
          
          row.appendChild(actionsCell);
          tokenBody.appendChild(row);
        });
      }
      
      // Toggle terrain mode
      terrainModeBtn.addEventListener('click', () => {
        state.terrainMode = !state.terrainMode;
        terrainModeBtn.textContent = `Terrain Mode: ${state.terrainMode ? 'ON' : 'OFF'}`;
        terrainModeBtn.className = `px-3 py-1 ${state.terrainMode ? 'bg-green-700' : 'bg-amber-900'} text-white rounded`;
        
        // Deselect token if in terrain mode
        if (state.terrainMode && state.selectedToken) {
          state.selectedToken = null;
          document.querySelectorAll('.token').forEach(el => {
            el.style.boxShadow = '';
          });
        }
      });
      
      // Clear grid
      clearGridBtn.addEventListener('click', () => {
        if (confirm('Are you sure you want to clear the grid?')) {
          state.tokens = [];
          renderTokens();
          updateTokenTable();
        }
      });
      
      // Add to combat
      addToCombatBtn.addEventListener('click', () => {
        const name = initiativeNameInput.value.trim();
        if (!name) return;
        
        state.combatants.push({
          id: Date.now() + Math.random(),
          name,
          type: initiativeTypeSelect.value,
          initiative: null,
          dexMod: parseInt(dexModInput.value) || 0
        });
        
        initiativeNameInput.value = '';
        dexModInput.value = '0';
        updateInitiativeTable();
      });
      
      // Update initiative table
      function updateInitiativeTable() {
        if (state.combatants.length === 0) {
          initiativeBody.innerHTML = '<tr><td colspan="4" class="text-center">Add combatants to start tracking initiative</td></tr>';
          return;
        }
        
        // Sort by initiative (null values at the bottom)
        const sortedCombatants = [...state.combatants].sort((a, b) => {
          if (a.initiative === null && b.initiative === null) return 0;
          if (a.initiative === null) return 1;
          if (b.initiative === null) return -1;
          return b.initiative - a.initiative;
        });
        
        initiativeBody.innerHTML = '';
        sortedCombatants.forEach((combatant, index) => {
          const row = document.createElement('tr');
          if (index === state.currentTurn) {
            row.style.backgroundColor = '#442200';
          }
          
          const initCell = document.createElement('td');
          const initInput = document.createElement('input');
          initInput.type = 'number';
          initInput.value = combatant.initiative !== null ? combatant.initiative : '';
          initInput.className = 'border p-0.5 w-14';
          initInput.addEventListener('change', (e) => {
            combatant.initiative = e.target.value === '' ? null : parseInt(e.target.value);
            updateInitiativeTable();
          });
          
          const rollBtn = document.createElement('button');
          rollBtn.textContent = 'Roll';
          rollBtn.className = 'ml-1 px-1 py-0.5 btn-primary rounded text-xs';
          rollBtn.addEventListener('click', () => {
            const roll = Math.floor(Math.random() * 20) + 1;
            combatant.initiative = roll + combatant.dexMod;
            updateInitiativeTable();
          });
          
          initCell.appendChild(initInput);
          initCell.appendChild(rollBtn);
          row.appendChild(initCell);
          
          const nameCell = document.createElement('td');
          nameCell.textContent = combatant.name;
          row.appendChild(nameCell);
          
          const typeCell = document.createElement('td');
          typeCell.innerHTML = `<span class="inline-block w-3 h-3 rounded-full bg-${combatant.type === 'party' ? 'blue' : combatant.type === 'enemy' ? 'red' : 'yellow'}-500 mr-1"></span> ${combatant.type}`;
          row.appendChild(typeCell);
          
          const actionsCell = document.createElement('td');
          const removeBtn = document.createElement('button');
          removeBtn.textContent = 'Remove';
          removeBtn.className = 'px-2 py-0.5 bg-red-800 text-white rounded text-xs';
          removeBtn.addEventListener('click', () => {
            state.combatants = state.combatants.filter(c => c.id !== combatant.id);
            if (state.currentTurn >= state.combatants.length) {
              state.currentTurn = 0;
            }
            updateInitiativeTable();
            updateTurnDisplay();
          });
          actionsCell.appendChild(removeBtn);
          
          row.appendChild(actionsCell);
          initiativeBody.appendChild(row);
        });
        
        // Update current turn display
        updateTurnDisplay();
      }
      
      // Roll initiative for all
      rollInitiativeBtn.addEventListener('click', () => {
        state.combatants.forEach(combatant => {
          if (combatant.initiative === null) {
            const roll = Math.floor(Math.random() * 20) + 1;
            combatant.initiative = roll + combatant.dexMod;
          }
        });
        updateInitiativeTable();
      });
      
      // Surprise roll for all
      surpriseRollBtn.addEventListener('click', () => {
        state.combatants.forEach(combatant => {
          const roll = Math.floor(Math.random() * 20) + 1;
          // For surprise, we ignore DEX mod
          combatant.initiative = roll;
        });
        updateInitiativeTable();
      });
      
      // Next turn
      nextTurnBtn.addEventListener('click', () => {
        if (state.combatants.length === 0) return;
        
        state.currentTurn++;
        if (state.currentTurn >= state.combatants.length) {
          state.currentTurn = 0;
          state.round++;
        }
        
        updateTurnDisplay();
        updateInitiativeTable();
      });
      
      // Reset combat
      resetCombatBtn.addEventListener('click', () => {
        if (confirm('Are you sure you want to reset combat?')) {
          state.combatants.forEach(combatant => {
            combatant.initiative = null;
          });
          state.currentTurn = 0;
          state.round = 1;
          updateInitiativeTable();
          updateTurnDisplay();
        }
      });
      
      // Update turn display
      function updateTurnDisplay() {
        roundDisplay.textContent = `Round: ${state.round}`;
        
        if (state.combatants.length === 0) {
          turnDisplay.textContent = 'Current: None';
          return;
        }
        
        const sortedCombatants = [...state.combatants].sort((a, b) => {
          if (a.initiative === null && b.initiative === null) return 0;
          if (a.initiative === null) return 1;
          if (b.initiative === null) return -1;
          return b.initiative - a.initiative;
        });
        
        if (state.currentTurn < sortedCombatants.length) {
          turnDisplay.textContent = `Current: ${sortedCombatants[state.currentTurn].name}`;
        } else {
          turnDisplay.textContent = 'Current: None';
        }
      }
      
      // Initialize
      createGrid();
      updateTokenTable();
      updateInitiativeTable();
    });
  </script>
</body>
</html>
